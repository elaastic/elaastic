<!--
  ~ Elaastic - formative assessment system
  ~ Copyright (C) 2019. University Toulouse 1 Capitole, University Toulouse 3 Paul Sabatier
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

<!DOCTYPE html>
<html lang="en"
      th:replace="layout/leftMenu :: leftMenuLayout(title=~{::title}, content=~{::body}, pageSpecificMenu=~{::#pageSpecificMenu}, extraHeader=~{::head/script})"
      xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

<head>
    <title th:text="|elaastic: ${statementData.title}|"></title>
    <script type="text/javascript" th:src="@{/js/vega-min.js}"></script>
    <script type="text/javascript" th:src="@{/js/underscore-min.js}"></script>
    <script type="text/javascript" th:src="@{/js/graph/result-graph.js}"></script>
    <script type="text/javascript" th:src="@{/js/elaastic/graph/participation-rate-graph.js}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var feedbackList = JSON.parse([[${feedbackJson}]]);
        /*]]>*/
    </script>
</head>

<body>
<template id="feedbackTemplate">
    <div class="ui info message explanation">
        <strong>Rating: </strong>
        <span class="student-rating"></span>
        <br>
        <strong>Explanation: </strong>
        <span class="student-explanation"></span>
    </div>
</template>

<h1 style="line-height: 50%;">
        <span th:text="#{statistics.title}">
            Statistiques
        </span>
    -
    <span th:text="${assignment.title}"></span>
</h1>
<h2 style="font-size: 1.5em;" th:text="${statementData.title}"></h2>

<div class="ui top attached tabular menu">
    <div id="indicators-tab-title" class="item active" data-tab="indicators" th:text="#{statistics.indicators.tabname}">Indicators</div>
    <div class="item" data-tab="feedback" th:text="#{statistics.feedbacks.tabname}">Feedbacks</div>
    <div id="results-tab-title" class="item" data-tab="results" th:text="#{statistics.results.tabname}">Results</div>
</div>

<!-- Tab Indicators -->

<div class="ui tab bottom attached active segment" data-tab="indicators">

    <div class="grouped fields" style="margin-top: 1rem;" >
        <div class="field ui four column grid">
            <div class="six wide column">
                <h5 th:text="#{player.sequence.type}"></h5>
            </div>

            <div class="column">
                <div th:if="${statementData.hasChoices}" th:remove>
                    <span th:text="#{player.sequence.type.choice}"></span>
                </div>

                <div th:unless="${statementData.hasChoices}" th:remove>
                    <span th:text="#{player.sequence.type.open.ended}"></span>
                </div>
            </div>

            <div class="three wide column">
                <h5 th:text="#{player.sequence.mean.time}"></h5>
            </div>

            <div class="two wide column">
                [[${meanResponseTimes[0]}]] sec
            </div>

        </div>

        <div class="field ui four column grid">
            <div class="six wide column">
                <h5 th:text="#{player.sequence.type.execution}"></h5>
            </div>

            <div class="column">
                <div th:if="${typeExecution == 'faceToFace'}" th:remove>
                    <span th:text="#{sequence.interaction.executionContext.faceToFace}"></span>
                </div>
                <div th:if="${typeExecution == 'blended'}" th:remove>
                    <span th:text="#{sequence.interaction.executionContext.blended"></span>
                </div>
                <div th:if="${typeExecution == 'distance'}" th:remove>
                    <span th:text="#{sequence.interaction.executionContext.distance}"></span>
                </div>
            </div>
            <div class="ui two column grid"
                 th:if="${statementData.hasChoices and standardDeviation != -1.0}" th:remove>
                <div class="thirteen wide column">
                    <h5 th:text="#{player.sequence.standard.deviation}"></h5>
                </div>
                <div class="two wide column">
                    <span id="standard-deviation"></span>
                </div>
            </div>
        </div>

        <div class="field ui four column grid">
            <div class="six wide column">
                <h5 th:text="#{player.sequence.response.to.evaluate.count}"></h5>
            </div>
            <div class="column">
                <span th:text="${responseToEvaluateCount}"></span>
            </div>
        </div>

        <div class="field ui two column grid" style="padding: 1.5rem;">

            <div class="column">
                <h4 class="field" style="margin-bottom: 1.5rem;" th:text="#{player.sequence.statistics.confidenceDegree}"></h4>
                <div class="field">
                    <span th:text="#{player.sequence.interaction.confidenceDegree.TOTALLY_CONFIDENT}"></span>
                    <div class="ui two column grid">
                        <div class="seven wide column">
                            <div class="ui tiny progress" style="margin-top:0.6rem;"  id="progress-confidence-4">
                                <div class="bar" style="min-width : 0%"></div>
                            </div>
                        </div>
                        <div class="two wide column">
                            <label id="show-nb-confidence-4"></label>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <span th:text="#{player.sequence.interaction.confidenceDegree.CONFIDENT}"></span>
                    <div class="ui two column grid">
                        <div class="seven wide column">
                            <div class="ui tiny progress" style="margin-top:0.6rem;"  id="progress-confidence-3">
                                <div class="bar" style="min-width : 0%"></div>
                            </div>
                        </div>
                        <div class="two wide column">
                            <label id="show-nb-confidence-3"></label>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <span th:text="#{player.sequence.interaction.confidenceDegree.NOT_REALLY_CONFIDENT}"></span>
                    <div class="ui two column grid">
                        <div class="seven wide column">
                            <div class="ui tiny progress" style="margin-top:0.6rem;"  id="progress-confidence-2">
                                <div class="bar" style="min-width : 0%"></div>
                            </div>
                        </div>
                        <div class="two wide column">
                            <label id="show-nb-confidence-2"></label>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <span th:text="#{player.sequence.interaction.confidenceDegree.NOT_CONFIDENT_AT_ALL}"></span>
                    <div class="ui two column grid">
                        <div class="seven wide column">
                            <div class="ui tiny progress" style="margin-top:0.6rem;"  id="progress-confidence-1">
                                <div class="bar" style="min-width : 0%"></div>
                            </div>
                        </div>
                        <div class="two wide column">
                            <label id="show-nb-confidence-1"></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column">
                <h4 th:text="#{player.sequence.participation.rate}"></h4>
                <div id="vega-view-participation"></div>
            </div>
        </div>
<<<<<<< HEAD
        
        <h5 th:text="#{player.sequence.participation.rate}"></h5>
        <div id="vega-view-participation"></div>
=======
>>>>>>> 392204a... Merge time and update layout
    </div>

    <style>
        .ui.grid > .column:not(.row){
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
    </style>

</div>

<!-- Tab Feedback -->

<div class="ui bottom attached tab segment" data-tab="feedback">
    <div class="grouped fields">
        <div class="field" style="padding-bottom: 1.5rem;">
            <label th:text="#{player.sequence.feedback.statement}">
                I think I learned something from this sequence?
            </label>
        </div>
        <div class="field">
            <div class="ui five column grid">
                <div class="column">
                    <div class="ui checkbox ">
                        <input class="rating" type="checkbox" data-rating="5" onchange="applyFeedbackFilter()">
                        <label th:text="#{player.sequence.feedback.highdegree}">
                            Totally
                        </label>
                    </div>
                </div>
                <div class="four wide column">
                    <div class="ui tiny progress" style="margin-top:0.6rem;"  id="progress-rating-5">
                        <div class="bar" style="min-width : 0%"></div>
                    </div>
                </div>
                <div class="two wide column">
                    <label id="show-nb-feedback-by-rating-5"></label>
                </div>
                <div class="five wide column">
                    <label th:text="#{player.sequence.feedback.feedbacksnumber}">
                        Total number of feedbacks  :
                    </label>
                    <label id="show-nb-feedback"></label>
                </div>
            </div>
        </div>

        <div class="field">
            <div class="ui five column grid">
                <div class="column">
                    <div class="ui checkbox">
                        <input class="rating" type="checkbox" data-rating="4" onchange="applyFeedbackFilter()">
                        <label th:text="#{player.sequence.feedback.aboveaveragedegree}">
                            A bit
                        </label>
                    </div>
                </div>
                <div class="four wide column">
                    <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-4">
                        <div class="bar" style="min-width : 0%"></div>
                    </div>
                </div>
                <div class="two wide column">
                    <label id="show-nb-feedback-by-rating-4"></label>
                </div>
                <div class="five wide column">
                    <label th:text="#{player.sequence.feedback.averagerating}">
                        Average value of feedbacks ratings  :
                    </label>
                    <label id="show-average-rating"></label>
                </div>
            </div>
        </div>

        <div class="field">
            <div class="ui five column grid">
                <div class="column">
                    <div class="ui checkbox">
                        <input class="rating" type="checkbox" data-rating="3" onchange="applyFeedbackFilter()">
                        <label th:text="#{player.sequence.feedback.averagedegree}">
                            Average
                        </label>
                    </div>
                </div>
                <div class="four wide column">
                    <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-3">
                        <div class="bar" style="min-width : 0%"></div>
                    </div>
                </div>
                <div class="two wide column">
                    <label id="show-nb-feedback-by-rating-3"></label>
                </div>
            </div>
        </div>

        <div class="field">
            <div class="ui five column grid">
                <div class="column">
                    <div class="ui checkbox">
                        <input class="rating" type="checkbox" data-rating="2" onchange="applyFeedbackFilter()">
                        <label th:text="#{player.sequence.feedback.underaveragedegree}">
                            Not really
                        </label>
                    </div>
                </div>
                <div class="four wide column">
                    <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-2">
                        <div class="bar" style="min-width : 0%"></div>
                    </div>
                </div>
                <div class="two wide column">
                    <label id="show-nb-feedback-by-rating-2"></label>
                </div>
            </div>
        </div>

        <div class="field">
            <div class="ui five column grid">
                <div class="column">
                    <div class="ui checkbox">
                        <input class="rating" type="checkbox" data-rating="1" onchange="applyFeedbackFilter()">
                        <label th:text="#{player.sequence.feedback.lowdegree}">
                            Not at all
                        </label>
                    </div>
                </div>
                <div class="four wide column">
                    <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-1">
                        <div class="bar" style="min-width : 0%"></div>
                    </div>
                </div>
                <div class="two wide column">
                    <label id="show-nb-feedback-by-rating-1"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="ui dividing header">Feedbacks</div>

    <div id="feedbacks">
        <!-- List of feedbacks filled by JS -->
    </div>
<<<<<<< HEAD
<<<<<<< HEAD
=======
</div>

<script th:inline="javascript">
    $('.menu .item').tab();
    $(document).ready(function () {
        $('#result-accordion-[[${playerModel.resultsModel.sequenceId}]]').accordion()
    });
    $("#results-tab-title, #indicators-tab-title").click(function() {
        $(window).trigger("resize");
    });

    elaastic.renderParticipationRateGraph("#vega-view-participation", [[${participationData}]], {
        phase: [[#{statistics.participationgraph.phase}]]
    });

    let nbTotalConfidenceDegree = [[${nbConfidenceDegree1}]] + [[${nbConfidenceDegree2}]] + [[${nbConfidenceDegree3}]] + [[${nbConfidenceDegree4}]]

    $("#progress-confidence-1").progress({
        percent : (100 * [[${nbConfidenceDegree1}]])/nbTotalConfidenceDegree
    });
    $("#progress-confidence-2").progress({
        percent : (100 * [[${nbConfidenceDegree2}]])/nbTotalConfidenceDegree
    });
    $("#progress-confidence-3").progress({
        percent : (100 * [[${nbConfidenceDegree3}]])/nbTotalConfidenceDegree
    });
    $("#progress-confidence-4").progress({
        percent : (100 * [[${nbConfidenceDegree4}]])/nbTotalConfidenceDegree
    });

    $('#show-nb-confidence-1').text([[${nbConfidenceDegree1}]]);
    $('#show-nb-confidence-2').text([[${nbConfidenceDegree2}]]);
    $('#show-nb-confidence-3').text([[${nbConfidenceDegree3}]]);
    $('#show-nb-confidence-4').text([[${nbConfidenceDegree4}]]);

    $('#standard-deviation').text([[${standardDeviation}]])


    let feedbackTemplate = document.getElementById("feedbackTemplate")
    let feedbacksDiv = document.getElementById("feedbacks")
    displayFeedbackList(feedbackList);

    function applyFeedbackFilter() {
        let feedbacks;
        let checkedCheckboxes = Array.prototype.map.call(
            document.querySelectorAll('.rating:checked'),
            checkbox => parseInt(checkbox.dataset.rating)
        )

        if (checkedCheckboxes.length === 0) {
            feedbacks = feedbackList

        } else {
            feedbacks = feedbackList.filter(feedback => checkedCheckboxes.includes(feedback.rating))
        }
>>>>>>> dc35a94... Modified the participation rate graph filename
=======
</div>
>>>>>>> 392204a... Merge time and update layout

<!-- Tab Results -->

<div class="ui bottom attached tab segment" data-tab="results">
    <div th:with="components=${'/player/assignment/sequence/components'}">
        <div th:replace="|${components}/_statement.html| :: statement(${playerModel.statementPanelModel},${playerModel.statement})"></div>
        <div th:replace="|${components}/_results.html| :: results(${playerModel.resultsModel})"></div>
    </div>
</div>

<script th:inline="javascript">
    $('.menu .item').tab();
    $(document).ready(function () {
        $('#result-accordion-[[${playerModel.resultsModel.sequenceId}]]').accordion()
    });
    $("#results-tab-title, #indicators-tab-title").click(function() {
        $(window).trigger("resize");
    });

    elaastic.renderConfidenceGraph("#vega-view-participation", [[${participationData}]], {
        phase: [[#{statistics.participationgraph.phase}]],
        participationRate: [[#{statistics.participationgraph.participationRate}]]
    });

    let nbTotalConfidenceDegree = [[${nbConfidenceDegree1}]] + [[${nbConfidenceDegree2}]] + [[${nbConfidenceDegree3}]] + [[${nbConfidenceDegree4}]]

    $("#progress-confidence-1").progress({
        percent : (100 * [[${nbConfidenceDegree1}]])/nbTotalConfidenceDegree
    });
    $("#progress-confidence-2").progress({
        percent : (100 * [[${nbConfidenceDegree2}]])/nbTotalConfidenceDegree
    });
    $("#progress-confidence-3").progress({
        percent : (100 * [[${nbConfidenceDegree3}]])/nbTotalConfidenceDegree
    });
    $("#progress-confidence-4").progress({
        percent : (100 * [[${nbConfidenceDegree4}]])/nbTotalConfidenceDegree
    });

    $('#show-nb-confidence-1').text([[${nbConfidenceDegree1}]]);
    $('#show-nb-confidence-2').text([[${nbConfidenceDegree2}]]);
    $('#show-nb-confidence-3').text([[${nbConfidenceDegree3}]]);
    $('#show-nb-confidence-4').text([[${nbConfidenceDegree4}]]);

    $('#standard-deviation').text([[${standardDeviation}]])


    let feedbackTemplate = document.getElementById("feedbackTemplate")
    let feedbacksDiv = document.getElementById("feedbacks")
    displayFeedbackList(feedbackList);

    function applyFeedbackFilter() {
        let feedbacks;
        let checkedCheckboxes = Array.prototype.map.call(
            document.querySelectorAll('.rating:checked'),
            checkbox => parseInt(checkbox.dataset.rating)
        )

        if (checkedCheckboxes.length === 0) {
            feedbacks = feedbackList

        } else {
            feedbacks = feedbackList.filter(feedback => checkedCheckboxes.includes(feedback.rating))
        }

        removeFeedbackList()
        displayFeedbackList(feedbacks)
    }

    function removeFeedbackList() {
        while (feedbacksDiv.childNodes.length != 0) {
            feedbacksDiv.removeChild(feedbacksDiv.childNodes[0])
        }
    }

    function displayFeedbackList(feedbacks) {
        let ratings = [
            undefined,
            [[#{player.sequence.feedback.lowdegree}]],
            [[#{player.sequence.feedback.underaveragedegree}]],
            [[#{player.sequence.feedback.averagedegree}]],
            [[#{player.sequence.feedback.aboveaveragedegree}]],
            [[#{player.sequence.feedback.highdegree}]]
        ]

        feedbacks.forEach( feedback => {
            let clone = feedbackTemplate.content.children[0].cloneNode(true)
            clone.querySelector(".student-rating").innerHTML = ratings[feedback.rating]
            clone.querySelector(".student-explanation").innerHTML = feedback.explanation
            feedbacksDiv.appendChild(clone)
        })
    }

    let nbFeedbackByRating = []
    let nbFeedbacks = feedbackList.length
    let averageRating = 0;
    for (let i = 1 ; i <= 5 ; i++) {
        nbFeedbackByRating[i] = feedbackList.filter(feedback => feedback.rating == i).length
    }

    for (let i = 1; i <= 5; i++) {
        $('#progress-rating-' + i).progress({
            percent : (100 * nbFeedbackByRating[i])/nbFeedbacks
        });
        $('#show-nb-feedback-by-rating-' + i).text(nbFeedbackByRating[i]);
    }


    $('#show-nb-feedback').text(nbFeedbacks);

    if (nbFeedbacks != 0) {
        for (let i = 1; i <= 5; i++) {
            averageRating += nbFeedbackByRating[i] * i
        }
        averageRating = averageRating / nbFeedbacks
    }

    $('#show-average-rating').text(Math.round(averageRating));
</script>
</body>
</html>