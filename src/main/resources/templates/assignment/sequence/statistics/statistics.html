<!--
  ~ Elaastic - formative assessment system
  ~ Copyright (C) 2019. University Toulouse 1 Capitole, University Toulouse 3 Paul Sabatier
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

<!DOCTYPE html>
<html lang="en"
      th:replace="layout/leftMenu :: leftMenuLayout(title=~{::title}, content=~{::body}, pageSpecificMenu=~{::#pageSpecificMenu}, extraHeader=~{::head/script})"
      xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

<head>
    <title th:text="|elaastic: ${statementData.title}|"></title>
    <script type="text/javascript" th:src="@{/js/vega-min.js}"></script>
    <script type="text/javascript" th:src="@{/js/underscore-min.js}"></script>
    <script type="text/javascript" th:src="@{/js/graph/result-graph.js}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
            var feedbackList = JSON.parse([[${feedbackJson}]]);
        /*]]>*/
        feedbackList.push({rating: 1, explanation: "Rating 1"}, {rating: 3, explanation: "Rating 3"}, {rating: 2, explanation: "Rating 2"}, {rating: 4, explanation: "Rating 4"}, {rating: 5, explanation: "Rating 5"})
    </script>
</head>

<body>
    <template id="feedbackTemplate">
        <div class="ui info message explanation">
            <strong>Rating: </strong>
            <span class="student-rating"></span>
            <br>
            <strong>Explanation: </strong>
            <span class="student-explanation"></span>
        </div>
    </template>

    <h1 style="line-height: 50%;">
        <span th:text="#{statistics.title}">
            Statistiques
        </span>
            -
        <span th:text="${assignment.title}"></span>
    </h1>
    <h2 style="font-size: 1.5em;" th:text="${statementData.title}"></h2>

    <div class="ui top attached tabular menu">
        <div class="item active" data-tab="indicators" th:text="#{statistics.indicators.tabname}">Indicators</div>
        <div class="item" data-tab="feedback" th:text="#{statistics.feedbacks.tabname}">Feedbacks</div>
        <div id="results-tab-title" class="item" data-tab="results" th:text="#{statistics.results.tabname}">Results</div>
    </div>

    <div class="ui tab bottom attached active segment" data-tab="indicators">
        <a href="https://github.com/elaastic/elaastic-questions-server/issues/5">Content Incoming #5</a>
    </div>

    <div class="ui bottom attached tab segment" data-tab="feedback">
        <div class="grouped fields">
            <div class="field" style="padding-bottom: 1.5rem;">
                <label th:text="#{player.sequence.feedback.statement}">
                    I think I learned something from this sequence?
                </label>
            </div>
            <div class="field">
                <div class="ui five column grid">
                    <div class="column">
                        <div class="ui checkbox ">
                            <input class="rating"
                                   type="checkbox"
                                   data-rating="5"
                                   checked="true"
                                   onchange="applyFeedbackFilter()">
                            <label th:text="#{player.sequence.feedbackDegree.HIGH}">
                                Totally
                            </label>
                        </div>
                    </div>
                    <div class="four wide column">
                        <div class="ui tiny progress" style="margin-top:0.6rem;"  id="progress-rating-5">
                            <div class="bar" style="min-width : 0%"></div>
                        </div>
                    </div>
                    <div class="two wide column">
                        <label id="show-nb-feedback-by-rating-5"></label>
                    </div>
                    <div class="five wide column">
                        <label th:text="#{player.sequence.feedback.feedbacksnumber}">
                            Total number of feedbacks  :
                        </label>
                        <label id="show-nb-feedback"></label>
                    </div>
                </div>
            </div>

            <div class="field">
                <div class="ui five column grid">
                    <div class="column">
                        <div class="ui checkbox">
                            <input class="rating"
                                   type="checkbox"
                                   data-rating="4"
                                   checked="true"
                                   onchange="applyFeedbackFilter()">
                            <label th:text="#{player.sequence.feedbackDegree.ABOVE_AVERAGE}">
                                A bit
                            </label>
                        </div>
                    </div>
                    <div class="four wide column">
                        <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-4">
                            <div class="bar" style="min-width : 0%"></div>
                        </div>
                    </div>
                    <div class="two wide column">
                        <label id="show-nb-feedback-by-rating-4"></label>
                    </div>
                    <div class="five wide column">
                        <label th:text="#{player.sequence.feedback.averagerating}">
                            Average value of feedbacks ratings  :
                        </label>
                        <label id="show-average-rating"></label>
                    </div>
                </div>
            </div>

            <div class="field">
                <div class="ui five column grid">
                    <div class="column">
                        <div class="ui checkbox">
                            <input class="rating"
                                   type="checkbox"
                                   data-rating="3"
                                   checked="true"
                                   onchange="applyFeedbackFilter()">
                            <label th:text="#{player.sequence.feedbackDegree.AVERAGE}">
                                Average
                            </label>
                        </div>
                    </div>
                    <div class="four wide column">
                        <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-3">
                            <div class="bar" style="min-width : 0%"></div>
                        </div>
                    </div>
                    <div class="two wide column">
                        <label id="show-nb-feedback-by-rating-3"></label>
                    </div>
                </div>
            </div>

            <div class="field">
                <div class="ui five column grid">
                    <div class="column">
                        <div class="ui checkbox">
                            <input class="rating"
                                   type="checkbox"
                                   data-rating="2"
                                   checked="true"
                                   onchange="applyFeedbackFilter()">
                            <label th:text="#{player.sequence.feedbackDegree.UNDER_AVERAGE}">
                                Not really
                            </label>
                        </div>
                    </div>
                    <div class="four wide column">
                        <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-2">
                            <div class="bar" style="min-width : 0%"></div>
                        </div>
                    </div>
                    <div class="two wide column">
                        <label id="show-nb-feedback-by-rating-2"></label>
                    </div>
                </div>
            </div>

            <div class="field">
                <div class="ui five column grid">
                    <div class="column">
                        <div class="ui checkbox">
                            <input class="rating"
                                   type="checkbox"
                                   data-rating="1"
                                   checked="true"
                                   onchange="applyFeedbackFilter()">
                            <label th:text="#{player.sequence.feedbackDegree.LOW}">
                                Not at all
                            </label>
                        </div>
                    </div>
                    <div class="four wide column">
                        <div class="ui tiny progress" style="margin-top:0.6rem;" id="progress-rating-1">
                            <div class="bar" style="min-width : 0%"></div>
                        </div>
                    </div>
                    <div class="two wide column">
                        <label id="show-nb-feedback-by-rating-1"></label>
                    </div>
                </div>
            </div>

            <div class="ui five column grid">
                <div class="colum">
                    <button id="checkButton"
                            class="ui button"
                            type="button"
                            onclick="checkUncheckAll(true)"
                            th:text="#{player.sequence.checkAll}">
                        Check all
                    </button>
                    <button id="unCheckButton"
                            class="ui button"
                            type="button"
                            onclick="checkUncheckAll(false)"
                            th:text="#{player.sequence.uncheckAll}">>
                        Uncheck all
                    </button>
                </div>
            </div>

        </div>

        <div class="ui dividing header">Feedbacks</div>

        <div id="feedbacks">
            <!-- List of feedbacks filled by JS -->
        </div>



    </div>

    <div class="ui bottom attached tab segment" data-tab="results">
        <div th:with="components=${'/player/assignment/sequence/components'}">
            <div th:replace="|${components}/_statement.html| :: statement(${playerModel.statementPanelModel},${playerModel.statement})"></div>
            <div th:replace="|${components}/_results.html| :: results(${playerModel.resultsModel})"></div>
        </div>
    </div>

    <script th:inline="javascript">
        $('.menu .item').tab();
        $(document).ready(function () {
            $('#result-accordion-[[${playerModel.resultsModel.sequenceId}]]').accordion()
        })
        $("#results-tab-title").click(function() {
            $(window).trigger("resize");
        });

        /** Check - Uncheck Checkboxes */

        function checkUncheckAll(order) {
            let checkboxes = document.querySelectorAll('.rating')
            checkboxes.forEach( checkbox => checkbox.checked = order)
            applyFeedbackFilter()
        }

        /** -------------------------- */
        let feedbackTemplate = document.getElementById("feedbackTemplate")
        let feedbacksDiv = document.getElementById("feedbacks")
        displayFeedbackList(feedbackList);

        function applyFeedbackFilter() {
            let feedbacks =[];
            let checkedCheckboxes = Array.prototype.map.call(
                document.querySelectorAll('.rating:checked'),
                checkbox => parseInt(checkbox.dataset.rating)
            )

            if (checkedCheckboxes.length === 5) {
                feedbacks = feedbackList

            } else {
                feedbacks = feedbackList
                    .filter(feedback => checkedCheckboxes.includes(feedback.rating))
            }

            removeFeedbackList()
            displayFeedbackList(feedbacks)
        }

        function removeFeedbackList() {
            while (feedbacksDiv.childNodes.length != 0) {
                feedbacksDiv.removeChild(feedbacksDiv.childNodes[0])
            }
        }

        function displayFeedbackList(feedbacks) {
            feedbacks.sort((a,b) => a.rating <= b.rating ? 1 : -1)

            let ratings = [
                undefined,
                [[#{player.sequence.feedbackDegree.LOW}]],
                [[#{player.sequence.feedbackDegree.UNDER_AVERAGE}]],
                [[#{player.sequence.feedbackDegree.AVERAGE}]],
                [[#{player.sequence.feedbackDegree.ABOVE_AVERAGE}]],
                [[#{player.sequence.feedbackDegree.HIGH}]]
            ]

            feedbacks.forEach( feedback => {
                let clone = feedbackTemplate.content.children[0].cloneNode(true)
                clone.querySelector(".student-rating").innerHTML = ratings[feedback.rating]
                clone.querySelector(".student-explanation").innerHTML = feedback.explanation
                feedbacksDiv.appendChild(clone)
            })
        }

        let nbFeedbackByRating = []
        let nbFeedbacks = feedbackList.length
        let averageRating = 0;
        for (let i = 1 ; i <= 5 ; i++) {
            nbFeedbackByRating[i] = feedbackList.filter(feedback => feedback.rating == i).length
        }

        for (let i = 1; i <= 5; i++) {
            $('#progress-rating-' + i).progress({
                percent : (100 * nbFeedbackByRating[i])/nbFeedbacks
            });
            $('#show-nb-feedback-by-rating-' + i).text(nbFeedbackByRating[i]);
        }


        $('#show-nb-feedback').text(nbFeedbacks);

        if (nbFeedbacks != 0) {
            for (let i = 1; i <= 5; i++) {
                averageRating += nbFeedbackByRating[i] * i
            }
            averageRating = averageRating / nbFeedbacks
        }

        $('#show-average-rating').text(Math.round(averageRating));
    </script>
</body>
</html>