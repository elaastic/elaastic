<!--
  ~ Elaastic - formative assessment system
  ~ Copyright (C) 2019. University Toulouse 1 Capitole, University Toulouse 3 Paul Sabatier
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

<div th:fragment="question-feedback(model)"
     th:remove="tag"
     xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

    <div class="ui accordion segment"
         th:id="|question-feedback-accordion-${model.sequenceId}|">

        <div class="ui dividing active title header" style="margin-right: 1.25em;">
            <i class="dropdown icon"></i>
            <span th:text="#{player.sequence.feedback.title}">Point of view on the sequence</span>
        </div>

        <div class="ui basic large text segment active content"
             style="font-size: 1rem;"
             th:id="|sequence_${model.sequenceId}_pov|">

            <form class="ui form"
                  id="formulaire"
                  th:action="@{/player/sequence/{sequenceId}/submit-teacher-feedback(sequenceId=${model.sequenceId})}"
                  method="post">

                <p th:text="#{player.sequence.teacher.feedback.statement}">
                    In sights of the unfolding of the sequence:
                </p>

                 <div class="field" id="recommendRating">
                    <label th:text="#{player.sequence.teacher.feedback.first.statement}">
                        Do you think you could reuse this question in the future?
                    </label>
                     <input type="hidden"
                            name="reuseDegree"
                            v-model="reuseDegree"/>

                    <div class="ui fluid four item stackable menu">
                        <a th:each="confidenceDegree : ${model.teacherConfidenceDegreeValues}"
                           class="item"
                           th:attr="'v-on:click'=|setSelectedConfidenceDegree('${confidenceDegree.name()}', 'reuse')|, 'v-bind:class'=|{ active: selectedReuseDegree === '${confidenceDegree.name()}' }|"
                           th:text="#{|player.sequence.teacher.feedbackDegree.${confidenceDegree.name()}|}">
                        </a>
                    </div>
                </div>

                <div class="field" id="reuseRating">
                    <label th:text="#{player.sequence.teacher.feedback.second.statement}">
                        Would you recommend using this question to a colleague?
                    </label>
                    <input type="hidden"
                           name="recommendDegree"
                           v-model="recommendDegree"/>

                    <div class="ui fluid four item stackable menu">
                        <a th:each="confidenceDegree : ${model.teacherConfidenceDegreeValues}"
                           class="item"
                           th:attr="'v-on:click'=|setSelectedConfidenceDegree('${confidenceDegree.name()}', 'recommend')|, 'v-bind:class'=|{ active: selectedRecommendDegree === '${confidenceDegree.name()}' }|"
                           th:text="#{|player.sequence.teacher.feedbackDegree.${confidenceDegree.name()}|}">
                        </a>
                    </div>
                </div>

                <div class="field">
                    <p>You can justify your choices if you with </p>
                    <label>
                        <textarea name="explanation"
                                  th:placeholder="#{player.sequence.feedback.title}"
                                  th:text="${model.explanation}"
                                  :readonly="hasFeedback">
                        </textarea>
                    </label>
                </div>

                <div class="field">
                    <input class="ui primary button"
                           type="submit"
                           :disabled="hasFeedback"
                           th:value="#{player.sequence.interaction.submitResponse}"/>
                </div>
            </form>
        </div>
    </div>

    <style>
        #recommendRating .active.item {
            background-color: #dff0ff;
            color: #0e6eb8;
        }
        #reuseRating .active.item {
            background-color: #dff0ff;
            color: #0e6eb8;
        }
    </style>

    <script th:inline="javascript">
        $(document).ready(function () {
            $('#question-feedback-accordion-[[${model.sequenceId}]]').accordion()
        })

        let confidenceDegreeValues = [[${model.teacherConfidenceDegreeValues}]]

        getDegree = (index) => {
            return confidenceDegreeValues[index]
        }

        let vue = new Vue({
           el: '#formulaire',
            data: {
                hasFeedback: [[${model.hasSubmitedFeedback}]],
                recommendDegree: -1,
                selectedRecommendDegree: getDegree([[${model.recommendDegree}]]),
                reuseDegree: -1,
                selectedReuseDegree: getDegree([[${model.reuseDegree}]])
            },
            methods: {
                setSelectedConfidenceDegree: function (degree, type) {
                    if (!this.hasFeedback && type === 'reuse') {
                        this.selectedReuseDegree = degree
                        this.reuseDegree = confidenceDegreeValues.indexOf(degree)
                    }
                    else if (!this.hasFeedback && type === 'recommend') {
                        this.selectedRecommendDegree = degree
                        this.recommendDegree = confidenceDegreeValues.indexOf(degree)
                    }
                },
                readyToSubmit: function () {
                    return this.reuseDegree != null && this.recommendDegree != null
                }
            }
        })
    </script>
</div>
