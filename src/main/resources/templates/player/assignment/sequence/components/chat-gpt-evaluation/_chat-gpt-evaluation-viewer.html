<!--
  ~ Elaastic - formative assessment system
  ~ Copyright (C) 2019. University Toulouse 1 Capitole, University Toulouse 3 Paul Sabatier
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

<div xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html"
     th:fragment="chatGptEvaluation(chatGptEvaluationModel)"
     class="review" id="chat-gpt-evaluation-accordion" style="padding-bottom: 0"
     th:classappend="${chatGptEvaluationModel.hiddenByTeacher} ? 'hidden' : ''">

    <!--/* Header */-->
    <div class="review-header review-border" style="padding: 0 10px 0 0">
        <div class="reviewer-icon robot">
            <i class="laptop icon"></i>
        </div>
        <div class="info-header">
            <div class="reviewer">
                <span th:text="#{player.sequence.chatGptEvaluation.title}"></span>
            </div>
            <div class="score"
                 th:if="${chatGptEvaluationModel.status == 'DONE' && chatGptEvaluationModel.grade != null && !chatGptEvaluationModel.hiddenByTeacher}">
                <span th:text=" #{evaluation.score} + ' :'">Score :</span>
                <div class="ui label"
                     th:text="${chatGptEvaluationModel.grade} + '/5'"
                     data-inverted="" th:data-tooltip="#{player.sequence.chatGptEvaluation.grade.tooltip}"
                     data-position="top right">-/5
                </div>
            </div>
            <div class="actions"
                 th:if="${chatGptEvaluationModel.status == 'DONE' && chatGptEvaluationModel.canHideGrading}">
                <!--/* Hide evaluation action */-->
                <div class="hide-peer-grading" th:if="${chatGptEvaluationModel.canHideGrading}">
                    <a class="ui icon button"
                       th:if="${!chatGptEvaluationModel.hiddenByTeacher}"
                       th:attr="data-tooltip=#{evaluation.action.hideEvaluation}"
                       data-tooltip="Hide this evaluation"
                       data-position="top center"
                       th:onclick="|updateVisibilityOfGrading(${chatGptEvaluationModel.gradingID})|"
                    ><i class="eye icon"></i></a>

                    <a class="ui icon button hidden"
                       th:if="${chatGptEvaluationModel.hiddenByTeacher}"
                       th:attr="data-tooltip=#{evaluation.action.showEvaluation}"
                       data-tooltip="Show this evaluation"
                       data-position="top center"
                       th:onclick="|updateVisibilityOfGrading(${chatGptEvaluationModel.gradingID}, false)|"
                    ><i class="hide icon"></i></a>
                </div>
            </div>
        </div>
    </div>

    <!--/*
    Hidden message when the teacher hides it.
    It's only visible by the teacher because if an evaluation is hidden, only the teacher can see it.
    */-->
    <div class="review-border message-hidden" th:if="${chatGptEvaluationModel.hiddenByTeacher}">
        <div th:text="#{evaluation.hiddenByTeacher}">Hidden by the teacher</div>
        <div id="toggleContentDisplay" class="ui button black basic"
             style="text-transform: none; font-weight: initial"
             th:attr="evaluation-id=${chatGptEvaluationModel.gradingID}">

            <span id="show" th:text="#{evaluation.action.showEvaluationContent}">Show hidden content</span>
            <span id="hide" th:text="#{evaluation.action.hideEvaluationContent}"
                  style="display: none;">Mask hidden content</span>
        </div>
    </div>

    <!--/* Content */-->
    <div class="review-border" th:if="${!chatGptEvaluationModel.hiddenByTeacher}">
        <div th:replace="player/assignment/sequence/components/chat-gpt-evaluation/_chat-gpt-evaluation.html :: chatGptEvaluation(${chatGptEvaluationModel})"></div>
    </div>

    <!--/* Container for the Content when the evaluation is hidden */-->
    <div class="review-border" th:attr="evaluation-id=${chatGptEvaluationModel.gradingID}" th:id="content"
         th:if="${chatGptEvaluationModel.hiddenByTeacher}">
        <div th:replace="player/assignment/sequence/components/chat-gpt-evaluation/_chat-gpt-evaluation.html :: chatGptEvaluation(${chatGptEvaluationModel})"></div>
    </div>

    <!--/* If the evaluation is generated and it's not the teacher viewed the evaluation Then dispay the command */-->
    <div class="review-border"
         th:if="${chatGptEvaluationModel.status == 'DONE' && !chatGptEvaluationModel.viewedByTeacher && !chatGptEvaluationModel.hiddenByTeacher}">
        <th:block>
            <div th:replace="player/assignment/sequence/components/chat-gpt-evaluation/_chat-gpt-evaluation-student-command.html :: chatGptEvaluationCommand(${chatGptEvaluationModel})"></div>
        </th:block>
    </div>

    <script th:inline="javascript">
        function refreshFragment() {
            $.ajax({
                url: '/player/sequence/' + [[${chatGptEvaluationModel.sequenceId}]] + '/chat-gpt-evaluation',
                type: "GET",
                success: function (data) {
                    var chatGptEvaluationFragment = data.replace( /<!--[\s\S]*?-->/, '');
                    $("#chat-gpt-evaluation-accordion").replaceWith(chatGptEvaluationFragment);
                }
            });
        }

        $(function () {
            if ([[${chatGptEvaluationModel.status}]] === 'PENDING') {
                setTimeout(refreshFragment, 5000);
            }

            const responseId = [[${chatGptEvaluationModel.gradingID}]];
            const area = $('#content[evaluation-id="' + responseId + '"]');
            area.hide();

            const toggleContentBtn = $('#toggleContentDisplay[evaluation-id="' + responseId + '"]');
            const showBtn = toggleContentBtn.children('#show');
            const hideBtn = toggleContentBtn.children('#hide');

            toggleContentBtn.click(function () {
                area.toggle();
                showBtn.toggle();
                hideBtn.toggle();
            });

        });
    </script>

</div>
