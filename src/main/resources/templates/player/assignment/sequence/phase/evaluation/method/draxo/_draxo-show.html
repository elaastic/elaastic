<!--
  ~ Elaastic - formative assessment system
  ~ Copyright (C) 2019. University Toulouse 1 Capitole, University Toulouse 3 Paul Sabatier
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->
<!-- This fragment is used to display the evaluation of a Draxo method -->
<!-- To find the CSS file folow the path : static/css/draxo-show.css -->
<div th:fragment="draxoShow(draxoEvaluationModel, hideName)"
     th:remove="tag"
     xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

    <div class="review" th:with="explanation = ${draxoEvaluationModel.draxoEvaluation.getExplanation()}"
         th:classappend="${draxoEvaluationModel.hiddenByTeacher || (draxoEvaluationModel.isReported() && draxoEvaluationModel.canReactOnPeerGrading)} ? 'hidden' : ''">
        <!--/* PeerGrading header */-->
        <div class="review-header review-border">
            <div class="reviewer">
                <span th:text="#{draxo.reviewer} + ' :'">Reviewer</span>
                <span class="ui label" th:styleappend="${hideName} ? 'display: none'"
                      th:text="${draxoEvaluationModel.userCanDisplayStudentsIdentity} ? ${draxoEvaluationModel.graderName} : ${draxoEvaluationModel.graderNum}"></span>
            </div>
            <div class="score" th:if="${!draxoEvaluationModel.hiddenByTeacher}">
                <span th:text="#{draxo.score} + ' :'">Score</span>
                <span class="ui label" th:text="${draxoEvaluationModel.score ?: '-'}">2.5</span>
            </div>
            <div class="hide-peer-grading" th:if="${draxoEvaluationModel.canHidePeerGrading}">
                <a class="ui icon button"
                   th:if="${!draxoEvaluationModel.hiddenByTeacher}"
                   th:attr="data-tooltip=#{draxo.action.hideEvaluation}"
                   data-tooltip="Hide this evaluation"
                   data-position="top center"
                   th:onclick="|updateVisibilityOfPeerGrading(${draxoEvaluationModel.draxoPeerGradingId})|"
                >
                    <i class="eye icon"></i>
                </a>
                <a class="ui icon button hidden"
                   th:if="${draxoEvaluationModel.hiddenByTeacher}"
                   th:attr="data-tooltip=#{draxo.action.showEvaluation}"
                   data-tooltip="Show this evaluation"
                   data-position="top center"
                   th:onclick="|updateVisibilityOfPeerGrading(${draxoEvaluationModel.draxoPeerGradingId}, false)|"
                >
                    <i class="hide icon"></i>
                </a>
            </div>
        </div>
        <!--/* Hidden message when the teacher hides it */-->
        <div class="review-border message-hidden" th:if="${draxoEvaluationModel.hiddenByTeacher}">
            <div th:text="#{draxo.hiddenByTeacher}">Hidden by the teacher</div>
            <div class="ui button primary basic">
                Voir le contenu masqu&eacute;
            </div>
        </div>
        <!--/* Grid Draxo */-->
        <div class="review-DRAXO review-border"
             th:if="${!draxoEvaluationModel.hiddenByTeacher && !(draxoEvaluationModel.isReported() && draxoEvaluationModel.canReactOnPeerGrading)}">
            <h4 th:text="#{draxo.evaluationGrid}">Evaluation grid</h4>
            <div class="DRAXO-grid">
                <th:block
                        th:each="criteria : ${T(org.elaastic.questions.assignment.sequence.peergrading.draxo.criteria.Criteria).values()}"
                        th:with="optionType = ${criteria.getOptionType(draxoEvaluationModel.draxoEvaluation.get(criteria))}">

                    <div class="custom-step"
                         th:classappend="${optionType?.getCSSClass()}">

                        <div class="custom-step-content">
                            <span class="capital-letter" th:text="${criteria}">R</span>
                            <span th:text="#{${criteria.getMessageI18nKey(T(org.elaastic.questions.assignment.sequence.peergrading.draxo.criteria.CriteriaMessageKey).Header)}}">...</span>

                            <i class="green check icon" th:if="${optionType?.name == 'POSITIVE'}"></i>
                            <i class="red x icon" th:if="${optionType?.name == 'NEGATIVE'}"></i>
                            <i class="question icon" th:if="${optionType?.name == 'UNKNOWN'}"></i>
                        </div>
                    </div>
                </th:block>
            </div>

            <th:block th:with="rejectedCriteria = ${draxoEvaluationModel.draxoEvaluation.getRejectedCriteria()}">
                <div class="comment-area" th:if="${rejectedCriteria}">
                    <div class="comment-header">
                        <h4 th:text="#{${rejectedCriteria.getMessageI18nKey(T(org.elaastic.questions.assignment.sequence.peergrading.draxo.criteria.CriteriaMessageKey).Question)}}+' :'">
                            The answer is readable :</h4>
                        <div class="ui label"
                             th:text="#{${draxoEvaluationModel.draxoEvaluation.get(rejectedCriteria).codeI18n}}">
                            No
                        </div>
                    </div>
                    <div class="separator" th:if="${draxoEvaluationModel.draxoEvaluation.getExplanation()}"></div>
                    <div class="comment" th:if="${draxoEvaluationModel.draxoEvaluation.getExplanation()}">
                        <h4 th:text="#{draxo.feedback.label}">Feedback:</h4>
                        <div class="ui label" th:text="${draxoEvaluationModel.draxoEvaluation.getExplanation()}">
                            I am a relevant and constructive comment, to explain why the answer provided above
                            is not decipherable.
                        </div>
                    </div>
                </div>
            </th:block>
        </div>
        <!--/* Reaction for the feedback */-->
        <div class="review-border"
             th:if="${draxoEvaluationModel.canReactOnPeerGrading && draxoEvaluationModel.canBeReacted()}">
            <th:block
                    th:replace="player/assignment/sequence/components/peer-grading-reaction/_peer-grading-draxo-reaction.html :: peerGradingEvaluationCommand(${draxoEvaluationModel})">
            </th:block>
        </div>
        <!--/* Hidden message when the student reports it */-->
        <div class="review-border message-hidden"
             th:if="${!draxoEvaluationModel.hiddenByTeacher && (draxoEvaluationModel.isReported() && draxoEvaluationModel.canReactOnPeerGrading)}"
        >
            <div th:text="#{draxo.hiddenByYouReport}">As you reported this evaluation, it is hidden to you.</div>
        </div>
    </div>
    <!--/* Graphical feedback when the teacher hide a peergrading */-->
    <div class="ui message negative" th:attr="data-evaluation-id=${draxoEvaluationModel.draxoPeerGradingId}"
         id="feedbackMessage"
         style="display: none;"
    >
        <div class="header">Header of the message</div>
        <p class="content">Content of the message</p>
    </div>

    <script th:inline="javascript">

        /**
         * Update the peer grading visibility through asynchronous request
         * @param peerGradingID the ID of the peer grading to hide
         * @param markAsHidden if true, the peer grading will be marked as hidden else it will be marked as unhidden
         */
        function updateVisibilityOfPeerGrading(peerGradingID, markAsHidden = true) {
            /*<![CDATA[*/
            const responseId = [[${draxoEvaluationModel.responseId}]]
            /*]]> */
            console.log("hidePeerGrading");
            console.log(peerGradingID);
            const feedbackMessage = $('#feedbackMessage[data-evaluation-id="' + peerGradingID + '"]');
            let url = "/peer-grading/draxo/";
            url += markAsHidden ? "hide/" : "unhide/";
            url += peerGradingID;

            $.get(url, function (data) {
                if (data.success) {
                    // We update the container through the link of the detail
                    const explanationContainer = $('.explanation[data-response-id="' + responseId + '"]:visible')
                    for (const explanationContainerElement of explanationContainer) {
                        // If the explanation container has reviews, we click on the detail link, to reload it
                        if ($(explanationContainerElement).children('.reviews-container').html() !== "") {
                            $(explanationContainerElement).find('.detail-link').click();
                        }
                    }
                } else {
                    feedbackMessage.children('.header').css("color", " #9f3a38")
                    feedbackMessage.children('.header').text(data.header);
                    feedbackMessage.children('.content').text(data.content);

                    feedbackMessage.slideDown()
                    setTimeout(function () {
                        feedbackMessage.slideUp()
                    }, 5000)
                }
            });
        }
    </script>

</div>
