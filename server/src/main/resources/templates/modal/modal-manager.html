<!--
  ~ Elaastic - formative assessment system
  ~ Copyright (C) 2019. University Toulouse 1 Capitole, University Toulouse 3 Paul Sabatier
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->
<!--/* This fragment handles the display of modal. It should be called in the most upper level of the HTML */-->
<div th:fragment="modalManager">
    <div class="ui modal" id="loading_modal" style="display: none;">
        <div class="ui active dimmer">
            <div class="ui text loader" th:text="#{common.loading}">Loading</div>
        </div>
    </div>

    <script th:inline="javascript">
        $(function () {
            const loader = $('#loading_modal');
            const showDetailsModal = 'show-details-modal';
            const showReportModal = 'show-report-modal';
            const showConfigSequenceModal = 'show-config-sequence-modal';
            const showAllExplanationsModal = 'show-all-explanations-modal';

            window.addEventListener('message', (event) => {
                console.log('Received message: ' + event.data.command);
                switch (event.data.command) {
                    case showDetailsModal:
                        console.log('Details modal');
                        showDetails(event.data.userId, event.data.sequenceId);
                        break;
                    case showReportModal:
                        console.log('Report modal');
                        showReport(event.data.evaluationId, event.data.evaluationType);
                        break;
                    case showConfigSequenceModal:
                        console.log('Config sequence modal');
                        showConfigSequence(event.data.sequenceId);
                        break;
                    case showAllExplanationsModal:
                        console.log('All explanations modal');
                        let selector = '#all_explanations_for_' + event.data.sequenceId;
                        let urlToFetch = '/modal-manager/all-explanations/' + event.data.sequenceId;
                        showOrFetchModal(
                                selector,
                                urlToFetch,
                                () => saveAction(event.data.sequenceId, 'open', 'rationales_popup'),
                                () => saveAction(event.data.sequenceId, 'close', 'rationales_popup')
                        );
                        break;
                    default:
                        console.log('Unknown command: ' + event.data.command);
                        console.log(event.data);
                        break;
                }
            })

            /**
             * Hide the loader with a delay
             */
            function hideLoaderWithDelay() {
                // For some reason, when you display and hide two modals in a row very quickly,
                // the first one doesn't display.
                // So to "fix" this, we add a delay before hiding the loader
                setTimeout(function () {
                    loader.modal('hide');
                }, 1000);
            }

            /**
             * Show a modal.
             *
             * If the action provided is a function, it will be executed when the modal is shown or hidden.
             * Any other type of action will be ignored.
             *
             * @param modalSelector The selector of the modal to show
             * @param actionOnShow The action to execute when the modal is shown
             * @param actionOnHide The action to execute when the modal is hidden
             */
            function showModal(modalSelector, actionOnShow = null, actionOnHide = null) {
                $(modalSelector).modal({
                    onShow: function () {
                        // If an action is provided, we execute it
                        if (actionOnShow && typeof actionOnShow === 'function') actionOnShow()
                    },
                    onHide: function () {
                        // If an action is provided, we execute it
                        if (actionOnHide && typeof actionOnHide === 'function') actionOnHide()
                    }
                }).modal('show');
            }

            /**
             * Show a modal.
             * If the modal doesn't exist yet, it will be fetched from the server.
             *
             * If the action provided is a function, it will be executed when the modal is shown or hidden.
             * Any other type of action will be ignored.
             *
             * @param modalSelector The selector of the modal to show
             * @param urlToFetch The URL to fetch the modal
             * @param actionOnShow The action to execute when the modal is shown
             * @param actionOnHide The action to execute when the modal is hidden
             */
            function showOrFetchModal(modalSelector, urlToFetch, actionOnShow = null, actionOnHide = null) {
                let $modal = $(modalSelector);
                if ($modal.length) {
                    // If the modal already exists, we show it
                    showModal(modalSelector, actionOnShow, actionOnHide);
                } else {
                    loader.modal('show');
                    // If the modal doesn't exist, we fetch it
                    $.get(urlToFetch)
                            .done(function (data) {
                                $("body").append(data);
                                showModal(modalSelector, actionOnShow, actionOnHide);
                                hideLoaderWithDelay();
                            })
                            .fail(function () {
                                loader.modal('hide');
                                console.log("An error occurred while fetching the modal");
                            })
                }
            }

            /**
             * Show the results modal for a given user
             * @param userId
             * @param sequenceId
             */
            function showDetails(userId, sequenceId) {
                const selector = "#myResultsModal_" + userId;
                const urlModal = '/player/' + sequenceId + '/result/' + userId + '/modal';
                showOrFetchModal(selector, urlModal);
            }

            /**
             * Show the report modal for a given evaluation
             * <p>
             *     The modal is fetched from the server if it doesn't exist yet
             *     As a DRAXO and an AI evaluation can have the same ID, we need to specify the type of the evaluation
             * @param evaluationId The ID of the evaluation
             * @param evaluationType The type of the evaluation (IA or DRAXO)
             */
            function showReport(evaluationId, evaluationType) {
                let reportModalToFind;
                let urlModal = "/modal-manager/report/";
                if (evaluationType === 'IA') {
                    reportModalToFind = '#reportIAModal_' + evaluationId;
                    urlModal += 'ia/' + evaluationId;
                } else {
                    reportModalToFind = '#reportDRAXOModal_' + evaluationId;
                    urlModal += 'draxo/' + evaluationId;
                }

                showOrFetchModal(reportModalToFind, urlModal);
            }

            /**
             * Show the configuration modal for a given sequence
             * @param sequenceId The ID of the sequence
             */
            function showConfigSequence(sequenceId) {
                const selector = "#sequenceSpec_" + sequenceId;
                const urlModal = '/modal-manager/config-sequence/' + sequenceId;
                saveAction(sequenceId, 'open', 'configure_popup')
                showOrFetchModal(selector, urlModal);
            }

        });
    </script>
</div>