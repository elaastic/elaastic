<!--
  ~ Elaastic - formative assessment system
  ~ Copyright (C) 2019. University Toulouse 1 Capitole, University Toulouse 3 Paul Sabatier
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

<div th:fragment="command(commandModel)"
     th:with="sequenceId = ${commandModel.sequenceId}"
     class="ui attached stackable icon menu ob-start-sequence-5 ob-play-sequence-3"
     xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

    <script th:inline="javascript">
        function loadSequence(urlToFetch) {
            console.log(urlToFetch)

            $.get(urlToFetch)
                .done(function (data) {
                    window.location.reload();
                })
        }
    </script>

    <!--/* Start sequence */-->
    <a th:if="${commandModel.actionStartSequence.name() == 'ENABLED'}"
       class="item"
       href="#"
       style="width: 100%; text-align: center; display: block; outline: none;"
       th:id="'start-sequence-' + ${sequenceId}">

        <i class="green play icon"></i>
        <span th:text="#{player.sequence.start}">Start sequence</span>
    </a>

    <!--/* Start phase (n) */-->
    <a class="item"
       th:unless="${commandModel.actionStartInteraction.name() == 'HIDDEN'}"
       th:href="@{/player/interaction/{interactionId}/start(interactionId=${commandModel.interactionId})}">

        <i class="green play icon"
           th:classappend="${commandModel.actionStartInteraction.name() == 'DISABLED' ? 'disabled' : ''}"></i>
        <span th:styleappend="${commandModel.actionStartInteraction.name() == 'DISABLED' ? 'opacity: 0.45' : ''}"
              th:text="#{player.sequence.interaction.start(${commandModel.interactionRank})}"></span>
    </a>

    <!--/* Stop phase (n) */-->
    <a class="item"
       th:unless="${commandModel.actionStopInteraction.name() == 'HIDDEN'}"
       th:onclick="|loadSequence('@{/player/interaction/{interactionId}/stop(interactionId=${commandModel.interactionId})}')|">

        <i class="pause icon"></i>
        <span th:text="#{player.sequence.interaction.stop(${commandModel.interactionRank})}"></span>
    </a>

    <!--/* Start next phase (n) */-->
    <a class="item"
       th:unless="${commandModel.actionStartNextInteraction.name() == 'HIDDEN'}"
       th:onclick="|loadSequence('@{/player/interaction/{interactionId}/startNext(interactionId=${commandModel.interactionId})}')|">

        <i class="green play icon"></i>
        <span th:text="#{player.sequence.interaction.start(${commandModel.InteractionRank + 1})}"></span>
    </a>

    <!--/* Skip next phase */-->
    <a class="item"
       th:unless="${commandModel.actionStartNextInteraction.name() == 'HIDDEN'}"
       th:onclick="|loadSequence('@{/player/interaction/{interactionId}/skipNext(interactionId=${commandModel.interactionId})}')|">

        <i class="green forward icon"></i>
        <span th:text="#{player.sequence.interaction.start(${commandModel.InteractionRank + 2})}"></span>
    </a>

    <!--/* Reopen phase (n) */-->
    <a class="item"
       href="#"
       th:unless="${commandModel.actionReopenInteraction.name() == 'HIDDEN'}"
       th:onclick="|loadSequence('@{/player/interaction/{interactionId}/restart(interactionId=${commandModel.interactionId})}')|">

        <i class="red undo alternate  icon"></i>
        <span th:text="#{player.sequence.interaction.restart(${commandModel.interactionRank})}">Reopen phase {0}</span>
    </a>

    <div class="right menu">
        <!--/* Re-open sequence */-->
        <a class="item"
           th:unless="${commandModel.actionReopenSequence.name() == 'HIDDEN'}"
           th:onclick="|loadSequence('@{/player/sequence/{sequenceId}/reopen(sequenceId=${commandModel.sequenceId})}')|">

            <i class="red undo alternate icon"></i>
            <span th:text="#{player.sequence.reopenSequence}">Re-open sequence</span>
        </a>

        <!--/* Stop sequence */-->
        <a class="item ob-end-sequence-1"
           th:unless="${commandModel.actionStopSequence.name() == 'HIDDEN'}"
           th:onclick="|loadSequence('@{/player/sequence/{sequenceId}/stop(sequenceId=${commandModel.sequenceId})}')|">

            <i class="red stop icon"></i>
            <span th:text="#{player.sequence.readinteraction.stopSequence}">Stop sequence</span>
        </a>

        <!--/* Publish results */-->
        <a class="item ob-end-sequence-2"
           th:unless="${commandModel.actionPublishResults.name() == 'HIDDEN'}"
           th:onclick="|loadSequence('@{/player/sequence/{sequenceId}/publish-results(sequenceId=${commandModel.sequenceId})}')|">

            <i class="feed icon"></i>
            <span th:text="#{player.sequence.publishResults}">Publish results</span>
        </a>

        <!--/* Cancel publication of results */-->
        <a class="item"
           th:unless="${commandModel.actionUnpublishResults.name() == 'HIDDEN'}"
           th:onclick="|loadSequence('@{/player/sequence/{sequenceId}/unpublish-results(sequenceId=${commandModel.sequenceId})}')|">

            <i class="red close icon"></i>
            <span th:text="#{player.sequence.unpublishResults}">Cancel the publication of results</span>
        </a>

    </div>

    <script th:inline="javascript" th:if="${commandModel.actionStartSequence.name() == 'ENABLED'}">
        $(function () {
            let sequenceId = [[${sequenceId}]];

            $("#start-sequence-" + sequenceId).on("click", function () {
                // See modal-manager.html for the display logic of the modal
                window.parent.postMessage({
                    command: "show-config-sequence-modal",
                    sequenceId: sequenceId
                }, "*");
            });
        });
    </script>
</div>
